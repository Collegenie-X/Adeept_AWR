# 🚗 함수형 라인 추적 자율 주행차 사용 가이드

**초음파 센서 장애물 회피 기능 포함**

## 📋 특징

### ✨ 함수형 프로그래밍 방식
- **클래스 없음**: 모든 기능이 함수로 구현
- **한글 함수명**: 이해하기 쉬운 한국어 함수명 사용
- **주석형 함수명**: 함수명 자체가 설명 역할

### 🛡️ 통합 장애물 회피 시스템
- **3단계 거리 임계값**: 위험/경고/안전 구간
- **우선순위 제어**: 장애물 회피 > 라인 추적
- **다양한 회피 패턴**: 후진, 좌회전, 우회전

### 📊 상세한 모니터링
- **실시간 센서 상태**: 라인 위치 + 장애물 거리
- **주행 통계**: 회전 횟수, 회피 횟수 등
- **테스트 기능**: 개별 센서 테스트

## 🚀 실행 방법

### 기본 실행
```bash
# 대화형 모드
python3 functional_line_car.py

# 자동 실행 모드 (5초 후 자동 시작)
python3 functional_line_car.py --auto
```

### 사용 명령어
```
s - 자율 주행 시작
q - 정지 및 종료
h - 도움말
c - 현재 설정 보기
stat - 통계 보기
test_line - 라인 센서 테스트
test_ultra - 초음파 센서 테스트
```

## ⚙️ 설정 방법

### 속도 설정 (전역 상수)

```python
# 기본 주행 속도
직진_기본_속도 = 50  # 직진 기본 속도 (0-100)

# 회전 속도 (라인 추적)
좌회전시_우측모터_속도 = 60  # 빠른 쪽 모터
좌회전시_좌측모터_속도 = 20  # 느린 쪽 모터
우회전시_좌측모터_속도 = 60  # 빠른 쪽 모터
우회전시_우측모터_속도 = 20  # 느린 쪽 모터

# 라인 탐색 속도
라인탐색_회전속도 = 30  # 제자리 회전 속도
```

### 장애물 회피 설정

```python
# 거리 임계값 (cm)
위험거리_임계값 = 15    # 즉시 후진 (빨간불)
경고거리_임계값 = 30    # 회피 동작 (노란불)  
안전거리_임계값 = 50    # 감속 주행 (초록불)

# 회피 동작 속도
장애물회피_후진속도 = 40    # 후진 속도
장애물회피_회전속도 = 45    # 회피 회전 속도
장애물회피_감속비율 = 0.6   # 감속 비율 (60%)
```

## 🧠 동작 원리

### 1. 통합 제어 우선순위

```
1️⃣ 초음파 센서 → 전방 거리 측정
2️⃣ 장애물 위험도 평가 → 위험/경고/주의/안전
3️⃣ 위험도별 대응
   🚨 위험 (≤15cm): 즉시 후진
   ⚠️ 경고 (≤30cm): 후진 + 회전 회피
   🔶 주의 (≤50cm): 감속 + 라인 추적
   ✅ 안전 (>50cm): 정상 라인 추적
```

### 2. 라인 추적 로직

```
라인 센서 패턴 → 위치 계산 → 동작 결정
```

| 센서 상태 | 위치값 | 동작 | 함수 |
|-----------|--------|------|------|
| `010` | 0.0 | 직진 | `직진_주행()` |
| `100`, `110` | < 0 | 우회전 | `우회전_실행()` |
| `001`, `011` | > 0 | 좌회전 | `좌회전_실행()` |
| `000` | None | 탐색 | `라인탐색_회전()` |

### 3. 장애물 회피 패턴

#### 위험 상황 (≤15cm)
```python
def 장애물_후진회피():
    모터_속도_설정(-40, -40, "장애물 후진 회피")
```

#### 경고 상황 (≤30cm)
```python
def 장애물_좌회전회피():
    모터_속도_설정(45, -45, "장애물 좌회전 회피")

def 장애물_우회전회피():
    모터_속도_설정(-45, 45, "장애물 우회전 회피")
```

#### 주의 상황 (≤50cm)
```python
def 속도_감속적용(기본속도, 감속비율):
    return int(기본속도 * 감속비율)  # 60% 감속
```

## 🔧 함수 구조

### 주요 함수 그룹

#### 1. 하드웨어 제어 함수
- `하드웨어_초기화()`: 센서/모터 초기화
- `라인센서_데이터_읽기()`: 라인 위치 감지
- `초음파센서_거리_측정()`: 전방 거리 측정
- `모터_속도_설정()`: 좌우 모터 개별 제어

#### 2. 주행 제어 함수  
- `직진_주행()`: 직진 동작
- `좌회전_실행()`: 좌회전 동작
- `우회전_실행()`: 우회전 동작
- `라인탐색_회전()`: 라인 탐색 동작

#### 3. 장애물 회피 함수
- `장애물위험도_평가()`: 거리별 위험도 판단
- `장애물_후진회피()`: 후진 회피
- `장애물_좌회전회피()`: 좌회전 회피
- `장애물_우회전회피()`: 우회전 회피

#### 4. 통합 제어 함수
- `라인추적_제어로직()`: 라인 추적 로직
- `장애물회피_제어로직()`: 장애물 회피 로직  
- `통합_주행제어()`: 전체 제어 통합
- `제어루프_실행()`: 메인 제어 루프

#### 5. 모니터링 함수
- `통계정보_업데이트()`: 주행 데이터 수집
- `통계정보_출력()`: 통계 표시
- `라인센서_테스트()`: 라인 센서 테스트
- `초음파센서_테스트()`: 초음파 센서 테스트

## 📊 모니터링 정보

### 실시간 출력 예시
```
센서: [010] 위치: 0.0 - 중앙 | 거리: 85cm
🚗 직진 주행 (우측:50%, 좌측:50%)

센서: [100] 위치: -0.8 - 좌측 많이 | 거리: 25cm  
⚠️ 장애물 감속 주행 | 거리: 25cm | 라인: -0.8

🚨 장애물 회피 중 | 거리: 12cm
🚗 장애물 후진 회피 (우측:-40%, 좌측:-40%)
```

### 통계 정보
```
📊 주행 통계
==================================================
총 주행 시간: 45.3초
좌회전 횟수: 12
우회전 횟수: 8  
라인 분실 횟수: 3
장애물 감지 횟수: 5
회피 동작 횟수: 5
회전 빈도: 0.44회/초
회피 성공률: 100.0%
==================================================
```

## 🎯 장애물 회피 전략

### 1. 거리별 대응 전략

#### 🚨 위험 구간 (0-15cm)
- **동작**: 즉시 후진
- **목적**: 충돌 방지
- **지속**: 안전 거리 확보까지

#### ⚠️ 경고 구간 (16-30cm)  
- **동작**: 후진 + 회전 회피
- **목적**: 장애물 우회
- **패턴**: 랜덤 좌우 선택

#### 🔶 주의 구간 (31-50cm)
- **동작**: 60% 감속 + 라인 추적 
- **목적**: 안전한 라인 추적
- **특징**: 라인 우선 유지

#### ✅ 안전 구간 (51cm+)
- **동작**: 정상 라인 추적
- **목적**: 최적 성능 주행
- **특징**: 장애물 무시

### 2. 회피 패턴 선택

```python
def 장애물회피_제어로직(거리):
    위험도 = 장애물위험도_평가(거리)
    
    if 위험도 == "위험":
        장애물_후진회피()
    elif 위험도 == "경고":
        if random.random() < 0.5:
            장애물_좌회전회피()
        else:
            장애물_우회전회피()
    elif 위험도 == "주의":
        감속된_속도 = 속도_감속적용(직진_기본_속도, 0.6)
        직진_주행(감속된_속도)
    # 안전한 경우 라인 추적 계속
```

## 🔄 시스템 흐름

```
1. 하드웨어_초기화()
2. 자율주행_시작()
3. 제어루프_실행()
   ├── 초음파센서_거리_측정()
   ├── 장애물회피_제어로직()
   └── 라인추적_제어로직() (안전 시에만)
4. 자율주행_정지()
5. 시스템_정리()
```

## 🛠️ 튜닝 가이드

### 속도 튜닝
1. **안정성 우선**: 모든 속도 -20%
2. **성능 우선**: 직진 속도 +30%, 회전 속도 차이 증가
3. **회피 우선**: 회피 속도 증가, 임계값 증가

### 거리 튜닝
1. **보수적**: 모든 임계값 +10cm
2. **적극적**: 위험 거리 -5cm, 경고 거리 +5cm  
3. **균형적**: 기본값 유지

---

💡 **함수형 설계의 장점**: 각 기능이 독립된 함수로 분리되어 있어 개별 테스트와 수정이 용이합니다!
