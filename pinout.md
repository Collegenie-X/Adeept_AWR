# 🤖 라즈베리파이 자율주행 로봇 핀아웃 가이드

## 📋 목차
- [GPIO 핀 매핑 요약](#gpio-핀-매핑-요약)
- [모터 제어 (L298N)](#모터-제어-l298n)
- [라인 센서 (3개)](#라인-센서-3개)
- [초음파 센서 (HC-SR04)](#초음파-센서-hc-sr04)
- [LED 스트립 (WS2812)](#led-스트립-ws2812)
- [부저 (Buzzer)](#부저-buzzer)
- [서보 모터 (PCA9685)](#서보-모터-pca9685)
- [전원 및 접지](#전원-및-접지)
- [연결 다이어그램](#연결-다이어그램)
- [주의사항](#주의사항)

---

## 🎯 GPIO 핀 매핑 요약

| 기능 | GPIO 번호 | 물리 핀 | 설명 | 전압 레벨 |
|------|-----------|---------|------|-----------|
| **모터 A Enable** | GPIO 4 | 7 | 우측 모터 PWM 제어 | 3.3V |
| **모터 A Pin1** | GPIO 14 | 8 | 우측 모터 방향 제어 1 | 3.3V |
| **모터 A Pin2** | GPIO 15 | 10 | 우측 모터 방향 제어 2 | 3.3V |
| **모터 B Enable** | GPIO 17 | 11 | 좌측 모터 PWM 제어 | 3.3V |
| **모터 B Pin1** | GPIO 27 | 13 | 좌측 모터 방향 제어 1 | 3.3V |
| **모터 B Pin2** | GPIO 18 | 12 | 좌측 모터 방향 제어 2 | 3.3V |
| **LED 스트립** | GPIO 12 | 32 | WS2812 데이터 신호 | 3.3V |
| **초음파 Trigger** | GPIO 11 | 23 | HC-SR04 트리거 신호 | 3.3V |
| **초음파 Echo** | GPIO 8 | 24 | HC-SR04 에코 신호 | 3.3V |
| **라인센서 좌측** | GPIO 20 | 38 | 좌측 라인 감지 | 3.3V |
| **라인센서 중앙** | GPIO 16 | 36 | 중앙 라인 감지 | 3.3V |
| **라인센서 우측** | GPIO 19 | 35 | 우측 라인 감지 | 3.3V |
| **부저** | GPIO 20 | 38 | 사운드 출력 (좌측 라인센서 공유) | 3.3V |

---

## 🚗 모터 제어 (L298N)

### 📍 연결 정보
L298N 듀얼 모터 드라이버를 사용하여 4개의 기어모터를 제어합니다.

#### 라즈베리파이 → L298N 연결
```
라즈베리파이 핀        L298N 핀        기능
GPIO 4  (물리 7)   →   ENA           모터A Enable (PWM)
GPIO 14 (물리 8)   →   IN1           모터A 방향 제어 1
GPIO 15 (물리 10)  →   IN2           모터A 방향 제어 2
GPIO 17 (물리 11)  →   ENB           모터B Enable (PWM)
GPIO 27 (물리 13)  →   IN3           모터B 방향 제어 1
GPIO 18 (물리 12)  →   IN4           모터B 방향 제어 2
```

#### L298N → 모터 연결
```
L298N 출력            모터 연결
OUT1, OUT2        →   우측 앞바퀴 모터 (Motor A)
OUT3, OUT4        →   우측 뒷바퀴 모터 (Motor A 병렬)
OUT1, OUT2        →   좌측 앞바퀴 모터 (Motor B)
OUT3, OUT4        →   좌측 뒷바퀴 모터 (Motor B 병렬)
```

#### 전원 연결
```
L298N 전원 핀         연결
VCC (Logic)       →   라즈베리파이 5V (물리 2번 핀)
VCC (Motor)       →   외부 배터리 12V (7.4V~12V)
GND               →   공통 접지
```

### ⚙️ 모터 제어 로직
```python
# 전진: 모든 모터 시계방향
IN1=HIGH, IN2=LOW   # 우측 모터 전진
IN3=HIGH, IN4=LOW   # 좌측 모터 전진

# 후진: 모든 모터 반시계방향
IN1=LOW, IN2=HIGH   # 우측 모터 후진
IN3=LOW, IN4=HIGH   # 좌측 모터 후진

# 좌회전: 우측 모터만 회전
IN1=HIGH, IN2=LOW   # 우측 모터 전진
IN3=LOW, IN4=LOW    # 좌측 모터 정지

# 우회전: 좌측 모터만 회전
IN1=LOW, IN2=LOW    # 우측 모터 정지
IN3=HIGH, IN4=LOW   # 좌측 모터 전진
```

---

## 👁️ 라인 센서 (3개)

### 📍 연결 정보
적외선 라인 센서 3개를 사용하여 라인을 추적합니다.

```
센서 위치             라즈베리파이 연결
좌측 센서     →       GPIO 20 (물리 38번)
중앙 센서     →       GPIO 16 (물리 36번)
우측 센서     →       GPIO 19 (물리 35번)

전원 연결
VCC          →       3.3V (물리 1번)
GND          →       GND (물리 6번)
```

### 🔧 센서 특성
- **센서 타입**: 적외선 반사형 센서
- **감지 거리**: 2~10mm
- **출력**: 디지털 (HIGH: 라인 감지, LOW: 바닥 감지)
- **동작 전압**: 3.3V ~ 5V
- **소비 전류**: 약 20mA per 센서

### 📊 라인 감지 로직
```python
라인 위치 판정:
좌측=0, 중앙=1, 우측=0  →  중앙 라인 (직진)
좌측=1, 중앙=0, 우측=0  →  좌측 라인 (우회전 필요)
좌측=0, 중앙=0, 우측=1  →  우측 라인 (좌회전 필요)
좌측=0, 중앙=0, 우측=0  →  라인 없음 (후진)
```

---

## 📡 초음파 센서 (HC-SR04)

### 📍 연결 정보
장애물 감지를 위한 초음파 거리 센서입니다.

```
HC-SR04 핀           라즈베리파이 연결
VCC              →   5V (물리 2번)
GND              →   GND (물리 6번)
Trig             →   GPIO 11 (물리 23번)
Echo             →   GPIO 8 (물리 24번)
```

### 🔧 센서 사양
- **측정 범위**: 2cm ~ 400cm
- **정확도**: ±3mm
- **측정 각도**: <15°
- **동작 전압**: 5V
- **소비 전류**: 15mA
- **초음파 주파수**: 40kHz

### ⚡ 동작 원리
```python
1. Trig 핀에 10μs HIGH 펄스 전송
2. 센서가 초음파 8개 펄스 발생
3. Echo 핀에서 반사파 수신까지 시간 측정
4. 거리 = (시간 × 음속) / 2
   음속 = 340m/s = 34000cm/s
```

### 📏 거리별 동작
```
거리 범위          동작
0-10cm        →   비상 정지 (빨간색 LED)
10-20cm       →   장애물 회피 (주황색 LED)
20-40cm       →   속도 감소 (노란색 LED)
40cm+         →   정상 주행 (초록색 LED)
```

---

## 💡 LED 스트립 (WS2812)

### 📍 연결 정보
상태 표시를 위한 개별 제어 가능한 RGB LED 스트립입니다.

```
WS2812 핀           라즈베리파이 연결
VCC              →   5V (물리 2번)
GND              →   GND (물리 6번)
DIN              →   GPIO 12 (물리 32번)
```

### 🔧 LED 사양
- **LED 개수**: 16개
- **색상**: RGB (각 색상 256단계)
- **동작 전압**: 5V
- **소비 전류**: 최대 60mA per LED (16개 = 960mA)
- **신호 주파수**: 800kHz
- **제어 방식**: SPI-like 시리얼 통신

### 🎨 상태별 색상 코드
```python
로봇 상태            RGB 값              색상
IDLE              (0, 0, 50)         어두운 파랑
MOVING            (0, 255, 0)        초록
OBSTACLE          (255, 255, 0)      노랑
LINE_FOLLOWING    (0, 255, 255)      시안
LOST              (255, 100, 0)      주황
ERROR             (255, 0, 0)        빨강
SHUTDOWN          (100, 0, 100)      보라
```

---

## 🔊 부저 (Buzzer)

### 📍 연결 정보
소리를 통한 상태 알림 및 경고음 출력용 부저입니다.

```
부저 핀              라즈베리파이 연결
+VCC             →   GPIO 20 (물리 38번)
-GND             →   GND (물리 39번)
```

### 🔧 부저 사양
- **타입**: 액티브 부저 (내장 발진기)
- **동작 전압**: 3.3V ~ 5V
- **소비 전류**: 약 30mA
- **주파수**: 2300Hz ± 300Hz
- **음압 레벨**: 85dB (10cm 거리)

### 🎵 사운드 패턴
```python
상황별 소리 패턴:
시작        →   삐- (0.5초)
장애물 감지  →   삐삐- (0.2초 x 2)
라인 분실    →   삐-삐-삐- (0.3초 x 3)
비상 정지    →   삐----- (2초 연속)
종료        →   삐삐삐- (0.1초 x 3)
```

---

## 🎯 서보 모터 (PCA9685)

### 📍 연결 정보 (선택적 기능)
카메라 각도 조절 등을 위한 서보 모터 제어용 PWM 확장 보드입니다.

```
PCA9685 핀          라즈베리파이 연결
VCC              →   5V (물리 2번)
GND              →   GND (물리 6번)
SDA              →   SDA (물리 3번, GPIO 2)
SCL              →   SCL (물리 5번, GPIO 3)
```

### 🔧 PCA9685 사양
- **채널 수**: 16채널
- **PWM 주파수**: 40Hz ~ 1000Hz (서보용 50Hz)
- **분해능**: 12bit (4096단계)
- **인터페이스**: I2C
- **주소**: 0x40 (기본값)

---

## ⚡ 전원 및 접지

### 🔌 전원 분배
```
전원 소스            전압    용도
라즈베리파이 5V   →   5V     센서, LED, 부저, PCA9685
외부 배터리       →   12V    모터 (L298N VCC)
라즈베리파이 3.3V →   3.3V   GPIO 로직 레벨
```

### 🔗 접지 연결
```
모든 GND 핀을 공통 접지에 연결:
- 라즈베리파이 GND (물리 6, 9, 14, 20, 25, 30, 34, 39번)
- L298N GND
- 센서들 GND
- LED 스트립 GND
- 부저 GND
- 외부 배터리 GND (-)
```

---

## 📊 연결 다이어그램

### 🎨 라즈베리파이 40핀 GPIO 레이아웃
```
        3.3V  (1) (2)  5V
   GPIO 2     (3) (4)  5V
   GPIO 3     (5) (6)  GND
   GPIO 4     (7) (8)  GPIO 14  ← 모터A Pin1
        GND   (9) (10) GPIO 15  ← 모터A Pin2
   GPIO 17   (11) (12) GPIO 18  ← 모터B Pin2
   GPIO 27   (13) (14) GND
   GPIO 22   (15) (16) GPIO 23
        3.3V (17) (18) GPIO 24
   GPIO 10   (19) (20) GND
   GPIO 9    (21) (22) GPIO 25
   GPIO 11   (23) (24) GPIO 8   ← 초음파 Echo
        GND  (25) (26) GPIO 7
   GPIO 0    (27) (28) GPIO 1
   GPIO 5    (29) (30) GND
   GPIO 6    (31) (32) GPIO 12  ← LED 스트립
   GPIO 13   (33) (34) GND
   GPIO 19   (35) (36) GPIO 16  ← 라인센서 중앙
   GPIO 26   (37) (38) GPIO 20  ← 라인센서 좌측 / 부저
        GND  (39) (40) GPIO 21

주요 핀 매핑:
- GPIO 4 (7): 모터A Enable
- GPIO 14 (8): 모터A Pin1
- GPIO 15 (10): 모터A Pin2
- GPIO 17 (11): 모터B Enable
- GPIO 27 (13): 모터B Pin1
- GPIO 18 (12): 모터B Pin2
- GPIO 12 (32): LED 스트립
- GPIO 11 (23): 초음파 Trig
- GPIO 8 (24): 초음파 Echo
- GPIO 20 (38): 라인센서 좌측 / 부저
- GPIO 16 (36): 라인센서 중앙
- GPIO 19 (35): 라인센서 우측
```

### 🔌 블록 다이어그램
```
[라즈베리파이]
    ├── GPIO 4,14,15,17,27,18 → [L298N] → [4개 기어모터]
    ├── GPIO 11,8 → [HC-SR04 초음파센서]
    ├── GPIO 20,16,19 → [3개 라인센서]
    ├── GPIO 12 → [WS2812 LED스트립]
    ├── GPIO 20 → [부저] (라인센서 좌측과 공유)
    ├── GPIO 2,3 → [PCA9685] → [서보모터들]
    └── 5V,3.3V,GND → [전원 분배]
```

---

## ⚠️ 주의사항

### ⚡ GPIO 핀 공유 문제
**중요**: 현재 핀 구성에서 GPIO 핀 공유로 인한 충돌이 발생할 수 있습니다.

1. **GPIO 12 사용**: LED 스트립 전용 핀
   - PWM 기능을 사용하여 안정적인 LED 제어
   - 다른 장치와 핀 공유 없음

2. **GPIO 20 공유**: 라인센서 좌측과 부저
   - 센서 읽기와 부저 출력 동시 사용 불가
   - **권장**: 부저를 다른 핀으로 이동 (예: GPIO 26)

### 🛡️ 전기적 안전
1. **전압 레벨 확인**: 라즈베리파이 GPIO는 3.3V 로직이므로 5V 직접 연결 금지
2. **전류 제한**: GPIO 핀당 최대 16mA, 전체 GPIO 최대 50mA
3. **공통 접지**: 모든 장치의 GND를 라즈베리파이 GND와 연결
4. **전원 분리**: 모터용 전원과 로직용 전원 분리 사용

### 🔧 연결 체크리스트
- [ ] 모든 전원 연결 확인 (5V, 3.3V, GND)
- [ ] GPIO 핀 번호 재확인 (BCM vs BOARD 모드)
- [ ] 단선/합선 체크
- [ ] 극성 확인 (특히 전원, LED)
- [ ] 접촉 불량 확인

### 💻 소프트웨어 설정
```bash
# GPIO 라이브러리 설치
sudo apt update
sudo apt install python3-rpi.gpio

# WS2812 LED 라이브러리 설치
sudo pip3 install rpi_ws281x

# PCA9685 라이브러리 설치
sudo pip3 install adafruit-circuitpython-pca9685

# I2C 활성화
sudo raspi-config
# → Interface Options → I2C → Enable
```

### 🚀 초기 테스트 순서
1. **전원 테스트**: LED로 전원 공급 확인
2. **GPIO 출력 테스트**: 부저로 출력 확인
3. **GPIO 입력 테스트**: 라인센서로 입력 확인
4. **PWM 테스트**: LED 밝기 조절 확인
5. **모터 테스트**: 개별 모터 동작 확인
6. **통합 테스트**: 전체 시스템 동작 확인

### 🧪 테스트 파일
프로젝트의 `hardware/` 폴더에 각 구성요소별 테스트 파일이 준비되어 있습니다:

```bash
# 통합 로봇 제어 (메인 프로그램)
python3 main.py

# 개별 하드웨어 테스트
python3 hardware/test_gear_motors.py     # 기어 모터 테스트
python3 hardware/test_line_sensors.py   # 라인 센서 테스트  
python3 hardware/test_ultrasonic_sensor.py  # 초음파 센서 테스트
sudo python3 hardware/test_led_strip.py     # LED 스트립 테스트 (root 권한 필요)
python3 hardware/test_servo_motors.py   # 서보 모터 테스트

# 서보모터 단일 제어 모드
python3 hardware/test_servo_motors.py --single
```

### 🤖 메인 프로그램 기능
`main.py`는 모든 하드웨어를 통합한 자율주행 로봇 제어 프로그램입니다:

- **라인 추적 모드**: 3개 라인센서로 라인을 따라 주행
- **장애물 회피 모드**: 초음파 센서로 장애물 감지 및 회피
- **자율 주행 모드**: 라인 추적 + 장애물 회피 결합
- **수동 제어 모드**: 키보드로 직접 제어 (w/a/s/d)
- **LED 상태 표시**: 로봇 상태에 따른 시각적 피드백
- **서보모터 제어**: 16채널 PWM을 통한 정밀 제어

각 테스트 파일은 모듈형으로 설계되어 있어 독립적으로 실행 가능하며, 다른 프로젝트에서도 임포트하여 사용할 수 있습니다.

---

## 📞 지원 및 참고자료

### 📚 관련 문서
- [라즈베리파이 GPIO 공식 문서](https://www.raspberrypi.org/documentation/usage/gpio/)
- [L298N 데이터시트](../../datasheet/L298.pdf)
- [HC-SR04 데이터시트](../../datasheet/GS2678.pdf)
- [PCA9685 데이터시트](../../datasheet/PCA9685.pdf)

### 🛠️ 디버깅 도구
```bash
# GPIO 상태 확인
gpio readall

# I2C 장치 스캔
i2cdetect -y 1

# 전압 측정
vcgencmd measure_volts

# 온도 확인
vcgencmd measure_temp
```

---

**📝 작성일**: 2024년  
**🔄 최종 수정**: 통합 main.py 제작 및 전체 시스템 완성  
**📧 문의**: 시스템 통합 및 하드웨어 연결 관련  
**⚠️ 중요**: GPIO 20 공유 문제 해결 필요 (라인센서 좌측 + 부저)

## 📋 핀아웃 요약 (최종 확정)

| 구성요소 | GPIO | 물리핀 | 기능 | 상태 |
|---------|------|--------|------|------|
| **모터 A Enable** | 4 | 7 | 우측 모터 PWM | ✅ 확정 |
| **모터 A Pin1** | 14 | 8 | 우측 모터 방향1 | ✅ 확정 |
| **모터 A Pin2** | 15 | 10 | 우측 모터 방향2 | ✅ 확정 |
| **모터 B Enable** | 17 | 11 | 좌측 모터 PWM | ✅ 확정 |
| **모터 B Pin1** | 27 | 13 | 좌측 모터 방향1 | ✅ 확정 |
| **모터 B Pin2** | 18 | 12 | 좌측 모터 방향2 | ✅ 확정 |
| **초음파 Trigger** | 11 | 23 | HC-SR04 트리거 | ✅ 확정 |
| **초음파 Echo** | 8 | 24 | HC-SR04 에코 | ✅ 확정 |
| **라인센서 좌측** | 20 | 38 | 좌측 라인감지 | ⚠️ 부저와 공유 |
| **라인센서 중앙** | 16 | 36 | 중앙 라인감지 | ✅ 확정 |
| **라인센서 우측** | 19 | 35 | 우측 라인감지 | ✅ 확정 |
| **LED 스트립** | 12 | 32 | WS2812 제어 | ✅ 확정 |
| **부저** | 20 | 38 | 사운드 출력 | ⚠️ 라인센서와 공유 |
